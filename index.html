<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB Movilidad | Sistema de Cotizaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body { 
            background: #ffffff;
            color: #333333;
            line-height: 1.6;
        }
        
        :root {
            --primary-red: #d40000;
            --primary-blue: #0056b3;
            --primary-dark: #1a1a2e;
        }
        
        /* HEADER CON BANNER IPB - MODIFICADO */
        .header-banner {
            width: 100%;
            background: linear-gradient(135deg, #1a2a3a 0%, #2c3e50 100%);
            padding: 20px 0;
            text-align: center;
            border-bottom: 3px solid var(--primary-red);
        }

        .banner-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .banner-image {
            max-width: 100%;
            height: auto;
            max-height: 150px;
        }

        .header-subtitle {
            background: var(--primary-red);
            color: white;
            padding: 12px 0;
            font-size: 1.2em;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .main-container {
            background: #f8f8f8;
            padding: 30px 20px;
        }
        
        .inventory-section {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .advanced-controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-weight: 600;
            color: var(--primary-red);
            font-size: 0.9em;
        }

        .search-box, .stock-filter, .brand-filter, .model-filter {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box:focus, .stock-filter:focus, .brand-filter:focus, .model-filter:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        .quote-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quote-btn:hover:not(:disabled) {
            background: #b30000;
            transform: translateY(-2px);
        }

        .quote-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .update-indicator {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .gac-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            color: #d40000;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .inventory-table th {
            background: #f8f8f8;
            color: var(--primary-red);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-red);
        }

        .inventory-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .inventory-table tr:hover {
            background: #f9f9f9;
        }

        .quantity-input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* FORMULARIO ALIADO */
        .client-form {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: var(--primary-red);
        }

        .form-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        .quote-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quote-items {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .quote-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .quote-total {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-red);
            padding: 15px;
        }

        /* PANEL KPIs SEGURO */
        .kpi-login {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid #9b59b6;
            display: none;
        }

        .kpi-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #27ae60;
            display: none;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .controls-grid, .form-grid {
                grid-template-columns: 1fr;
            }
            
            .banner-image {
                max-height: 100px;
            }
            
            .header-subtitle {
                font-size: 1em;
                padding: 10px 0;
            }
        }
    </style>
</head>
<body>
    <button class="admin-btn" id="adminToggle" style="display: none;">üîì Admin</button>

    <!-- HEADER CON BANNER IPB - CORREGIDO CON IMAGEN REAL -->
    <header class="header-banner">
        <div class="banner-container">
            <!-- IMAGEN REAL DE IPB MOVILIDAD -->
            <img src="https://raw.githubusercontent.com/yleal-lab/ipb-images/main/WhatsApp%20Image%202025-11-26%20at%209.52.10%20AM.jpeg" 
                 alt="IPB Movilidad C.A. - GAC Motor - DFSK - Shineray" 
                 class="banner-image">
        </div>
        <div class="header-subtitle">
            Sistema de Cotizaci√≥n para Aliados Comerciales
        </div>
    </header>
    
    <main class="main-container">
        <section class="inventory-section">
            <!-- FORMULARIO ALIADO COMERCIAL -->
            <div class="client-form" id="clientForm">
                <h3 style="color: var(--primary-red); margin-bottom: 20px; text-align: center;">
                    üìã DATOS DEL ALIADO COMERCIAL
                </h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Raz√≥n Social</label>
                        <input type="text" class="form-input" id="clientName" 
                               placeholder="Nombre de la empresa">
                    </div>
                    <div class="form-group">
                        <label class="form-label">RIF</label>
                        <input type="text" class="form-input" id="clientRIF" 
                               placeholder="J-XXXXXXXXX">
                    </div>
                </div>
            </div>

            <!-- CONTROLES AVANZADOS -->
            <div class="advanced-controls">
                <div class="controls-grid">
                    <div class="control-group">
                        <label class="control-label">üîç B√∫squeda</label>
                        <input type="text" class="search-box" id="searchInput" 
                               placeholder="Buscar por c√≥digo, descripci√≥n...">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">üìä Filtro de Stock</label>
                        <select class="stock-filter" id="stockFilter">
                            <option value="all">Todo el stock</option>
                            <option value="critical">Stock Cr√≠tico (< 5)</option>
                            <option value="low">Stock Bajo (0)</option>
                            <option value="medium">Stock Medio (1-10)</option>
                            <option value="high">Stock Alto (>10)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">üè∑Ô∏è Marca</label>
                        <select class="brand-filter" id="brandFilter">
                            <option value="all">Todas las marcas</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">üöó Modelo</label>
                        <select class="model-filter" id="modelFilter">
                            <option value="all">Todos los modelos</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="quote-btn" id="generateQuote" disabled>
                        üìã Generar Cotizaci√≥n
                    </button>
                    <button class="quote-btn" id="quickActions" style="background: #3498db;">
                        ‚ö° Acciones R√°pidas
                    </button>
                </div>
            </div>
            
            <div class="update-indicator">
                <span>üîÑ Sistema actualizado:</span> 
                <span id="update-time">Cargando an√°lisis...</span>
            </div>
            
            <!-- TABLA PRINCIPAL -->
            <div class="table-container">
                <div id="loading-message" class="loading">
                    <div class="gac-spinner"></div>
                    <div>Analizando inventario y tendencias...</div>
                </div>
                
                <div id="error-message" class="error" style="display: none;"></div>
                
                <div style="overflow-x: auto;">
                    <table class="inventory-table" id="inventory-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Marca</th>
                                <th>Serie</th>
                                <th>Modelo</th>
                                <th>N¬∞ Parte</th>
                                <th>Descripci√≥n</th>
                                <th>Stock</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- PANEL DE COTIZACI√ìN -->
            <div class="quote-panel" id="quotePanel">
                <h3>üìÑ Cotizaci√≥n Generada - COT-<span id="quoteNumber">00000</span></h3>
                <div class="quote-items" id="quoteItems"></div>
                <div class="quote-total" id="quoteTotal">
                    Total de items seleccionados: <span id="totalItems">0</span>
                </div>
                <div style="text-align: center;">
                    <button class="quote-btn" onclick="generatePDF()">
                        üì• Descargar PDF
                    </button>
                    <button class="quote-btn" onclick="clearQuote()" style="background: #cccccc; margin-left: 10px;">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
            </div>

            <!-- LOGIN DASHBOARD KPIs -->
            <div class="kpi-login" id="kpiLogin">
                <h3 style="color: #9b59b6; margin-bottom: 20px;">üîê Acceso al Dashboard de KPIs</h3>
                <div class="login-form">
                    <div class="form-group">
                        <label class="form-label">Usuario Administrador</label>
                        <input type="text" class="form-input" id="adminUser" placeholder="Usuario">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-input" id="adminPassword" placeholder="Contrase√±a">
                    </div>
                    <button class="quote-btn" onclick="loginToDashboard()" style="background: #9b59b6;">
                        üöÄ Acceder al Dashboard
                    </button>
                    <button class="quote-btn" onclick="hideKPILogin()" style="background: #cccccc;">
                        ‚Ü©Ô∏è Volver
                    </button>
                </div>
            </div>

            <!-- DASHBOARD KPIs -->
            <div class="kpi-panel" id="kpiDashboard">
                <h3 style="color: #27ae60; margin-bottom: 20px;">üìä Dashboard de KPIs - IPB Movilidad</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #27ae60; margin-bottom: 5px;">Total Productos</h4>
                        <p style="font-size: 24px; font-weight: bold;" id="totalProducts">0</p>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #27ae60; margin-bottom: 5px;">Cotizaciones</h4>
                        <p style="font-size: 24px; font-weight: bold;" id="totalQuotes">0</p>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #27ae60; margin-bottom: 5px;">Stock Bajo</h4>
                        <p style="font-size: 24px; font-weight: bold;" id="lowStock">0</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="productsChart"></canvas>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="quote-btn" onclick="hideDashboard()" style="background: #cccccc;">
                        ‚Ü©Ô∏è Volver al Sistema
                    </button>
                </div>
            </div>

            <!-- ACCESO KPIs -->
            <div style="text-align: center; margin-top: 25px;">
                <button class="quote-btn" onclick="showKPILogin()" id="accessKPIButton" 
                        style="background: #9b59b6;">
                    üîê Acceder a Dashboard de KPIs
                </button>
            </div>
        </section>
    </main>

    <script>
        // ===== SISTEMA PRINCIPAL =====
        const CSV_URL = 'inventario.csv';
        let inventoryData = [];
        let filteredData = [];
        let quoteItems = [];
        let productFrequency = JSON.parse(localStorage.getItem('productFrequency')) || {};
        let quoteCounter = parseInt(localStorage.getItem('quoteCounter')) || 1;

        // ===== FUNCIONES PRINCIPALES =====

        async function loadInventoryData() {
            try {
                showLoading(true);
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`Error al cargar el archivo: ${response.status}`);
                }

                const csvText = await response.text();
                inventoryData = parseCSVData(csvText);
                filteredData = [...inventoryData];
                
                if (inventoryData.length === 0) {
                    throw new Error('No se encontraron datos en el archivo CSV');
                }

                renderInventory();
                initializeFilters();
                updateSystemStatus();
                showNotification('‚úÖ Inventario cargado: ' + inventoryData.length + ' productos', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showError('‚ùå Error: ' + error.message);
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split(',').map(col => col.trim());
                
                if (columns.length >= 7) {
                    data.push({
                        codigo: columns[0] || 'N/A',
                        marca: columns[1] || 'N/A',
                        serie: columns[2] || 'N/A',
                        modelo: columns[3] || 'N/A',
                        numero_parte: columns[4] || 'N/A',
                        descripcion: columns[5] || 'N/A',
                        cantidad: parseInt(columns[6]) || 0
                    });
                }
            }
            
            return data;
        }

        function renderInventory() {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${item.codigo}</strong></td>
                    <td>${item.marca}</td>
                    <td>${item.serie}</td>
                    <td>${item.modelo}</td>
                    <td><code>${item.numero_parte}</code></td>
                    <td>${item.descripcion}</td>
                    <td style="font-weight: 600; color: ${getStockColor(item.cantidad)}">${item.cantidad}</td>
                    <td>
                        <input type="number" 
                               class="quantity-input" 
                               min="0" 
                               max="${item.cantidad}" 
                               value="0"
                               onchange="updateQuantity('${item.codigo}', this.value)">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            showLoading(false);
            document.getElementById('inventory-table').style.display = 'table';
            updateQuoteButton();
        }

        function initializeFilters() {
            const brands = [...new Set(inventoryData.map(item => item.marca))].filter(Boolean);
            const brandFilter = document.getElementById('brandFilter');
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });

            const models = [...new Set(inventoryData.map(item => item.modelo))].filter(Boolean);
            const modelFilter = document.getElementById('modelFilter');
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelFilter.appendChild(option);
            });

            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('stockFilter').addEventListener('change', applyFilters);
            document.getElementById('brandFilter').addEventListener('change', applyFilters);
            document.getElementById('modelFilter').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const stockFilter = document.getElementById('stockFilter').value;
            const brandFilter = document.getElementById('brandFilter').value;
            const modelFilter = document.getElementById('modelFilter').value;
            
            filteredData = inventoryData.filter(item => {
                const matchesSearch = 
                    item.codigo.toLowerCase().includes(searchTerm) ||
                    item.descripcion.toLowerCase().includes(searchTerm) ||
                    item.numero_parte.toLowerCase().includes(searchTerm);
                
                const matchesStock = 
                    stockFilter === 'all' ||
                    (stockFilter === 'critical' && item.cantidad < 5 && item.cantidad > 0) ||
                    (stockFilter === 'low' && item.cantidad === 0) ||
                    (stockFilter === 'medium' && item.cantidad >= 1 && item.cantidad <= 10) ||
                    (stockFilter === 'high' && item.cantidad > 10);
                
                const matchesBrand = brandFilter === 'all' || item.marca === brandFilter;
                const matchesModel = modelFilter === 'all' || item.modelo === modelFilter;
                
                return matchesSearch && matchesStock && matchesBrand && matchesModel;
            });
            
            renderInventory();
        }

        function updateQuantity(codigo, quantity) {
            quantity = parseInt(quantity) || 0;
            
            if (quantity > 0) {
                const item = inventoryData.find(item => item.codigo === codigo);
                if (item) {
                    updateProductFrequency(codigo, quantity, item.descripcion);
                    
                    const existingIndex = quoteItems.findIndex(qi => qi.codigo === codigo);
                    if (existingIndex >= 0) {
                        quoteItems[existingIndex].cantidad = quantity;
                    } else {
                        quoteItems.push({
                            ...item,
                            cantidad: quantity
                        });
                    }
                }
            } else {
                quoteItems = quoteItems.filter(qi => qi.codigo !== codigo);
            }
            
            updateQuotePanel();
            updateQuoteButton();
        }

        function updateQuotePanel() {
            const quoteItemsDiv = document.getElementById('quoteItems');
            const totalItemsSpan = document.getElementById('totalItems');
            const quotePanel = document.getElementById('quotePanel');
            
            if (quoteItems.length > 0) {
                quoteItemsDiv.innerHTML = quoteItems.map(item => `
                    <div class="quote-item">
                        <div>
                            <strong>${item.codigo}</strong> - ${item.descripcion}
                            <br><small>${item.marca} | ${item.modelo}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>Cantidad: ${item.cantidad}</strong>
                        </div>
                    </div>
                `).join('');
                
                totalItemsSpan.textContent = quoteItems.length;
                quotePanel.style.display = 'block';
            } else {
                quotePanel.style.display = 'none';
            }
        }

        function updateProductFrequency(codigo, quantity, description) {
            if (!productFrequency[codigo]) {
                productFrequency[codigo] = {
                    count: 0,
                    totalRequested: 0,
                    lastRequested: new Date().toISOString(),
                    description: description
                };
            }
            
            productFrequency[codigo].count++;
            productFrequency[codigo].totalRequested += quantity;
            productFrequency[codigo].lastRequested = new Date().toISOString();
            
            localStorage.setItem('productFrequency', JSON.stringify(productFrequency));
        }

        // ===== GENERACI√ìN DE PDF MEJORADO CON HTML2CANVAS =====
        async function generatePDF() {
            const clientName = document.getElementById('clientName').value.trim();
            const clientRIF = document.getElementById('clientRIF').value.trim();
            
            if (!clientName || !clientRIF) {
                showNotification('‚ùå Complete los datos del aliado comercial', 'error');
                return;
            }

            if (quoteItems.length === 0) {
                showNotification('‚ùå No hay items en la cotizaci√≥n', 'error');
                return;
            }

            showNotification('üìÑ Generando PDF...', 'info');
            
            // Generar n√∫mero de cotizaci√≥n
            const quoteNumber = `COT-${quoteCounter.toString().padStart(5, '0')}`;
            document.getElementById('quoteNumber').textContent = quoteCounter.toString().padStart(5, '0');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // SOLUCI√ìN HTML2CANVAS - CAPTURAR BANNER AUTOM√ÅTICAMENTE
            try {
                const bannerElement = document.querySelector('.header-banner');
                
                // Capturar el banner como imagen
                const canvas = await html2canvas(bannerElement, {
                    scale: 2, // Alta calidad
                    useCORS: true, // Permite im√°genes externas
                    backgroundColor: '#1a2a3a', // Color de fondo por defecto
                    logging: false, // Sin logs en consola
                    width: bannerElement.offsetWidth,
                    height: bannerElement.offsetHeight
                });
                
                // Convertir canvas a imagen
                const bannerImage = canvas.toDataURL('image/jpeg', 0.9);
                
                // Agregar banner al PDF (ajustar tama√±o seg√∫n necesidad)
                doc.addImage(bannerImage, 'JPEG', 5, 5, 200, 50);
                
            } catch (error) {
                console.warn('Error capturando banner, usando fallback:', error);
                // FALLBACK: banner simple si hay error
                doc.setFillColor(26, 42, 58);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.text('IPB MOVILIDAD C.A.', 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text('GAC MOTOR ‚Ä¢ DFSK ‚Ä¢ SHINERAY', 105, 28, { align: 'center' });
                doc.setFontSize(8);
                doc.text('Sistema de Cotizaci√≥n para Aliados Comerciales', 105, 35, { align: 'center' });
            }
            
            // POSICIONES AJUSTADAS PARA EL CONTENIDO (debajo del banner)
            const contentStartY = 65;
            
            // Informaci√≥n de cotizaci√≥n
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text(quoteNumber, 20, contentStartY);
            doc.setFontSize(10);
            
            const now = new Date();
            const validUntil = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            doc.text(`Fecha: ${now.toLocaleDateString()} - Hora: ${now.toLocaleTimeString()}`, 20, contentStartY + 10);
            doc.text(`V√°lida hasta: ${validUntil.toLocaleDateString()} - ${validUntil.toLocaleTimeString()} (24 horas)`, 20, contentStartY + 16);
            
            // Datos del aliado comercial
            doc.setFontSize(12);
            doc.text('DATOS DEL ALIADO COMERCIAL', 20, contentStartY + 30);
            doc.setFontSize(10);
            doc.text(`‚Ä¢ Raz√≥n Social: ${clientName}`, 20, contentStartY + 40);
            doc.text(`‚Ä¢ RIF: ${clientRIF}`, 20, contentStartY + 46);
            
            // Detalle de cotizaci√≥n
            doc.setFontSize(12);
            doc.text('DETALLE DE COTIZACI√ìN', 20, contentStartY + 60);
            
            // Encabezados de tabla
            doc.setFontSize(10);
            doc.text('C√≥digo', 20, contentStartY + 70);
            doc.text('Descripci√≥n', 50, contentStartY + 70);
            doc.text('Cant', 180, contentStartY + 70);
            
            let yPosition = contentStartY + 80;
            quoteItems.forEach((item, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(item.codigo, 20, yPosition);
                
                // Descripci√≥n en m√∫ltiples l√≠neas si es muy larga
                const descLines = doc.splitTextToSize(item.descripcion, 80);
                doc.text(descLines, 50, yPosition);
                
                doc.text(item.cantidad.toString(), 180, yPosition);
                
                yPosition += Math.max(10, descLines.length * 7);
            });
            
            // L√≠nea separadora y total
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPosition + 5, 190, yPosition + 5);
            
            doc.setFontSize(11);
            doc.text(`TOTAL ITEMS: ${quoteItems.length}`, 20, yPosition + 15);
            
            // Nota final
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            const noteText = 'NOTA: Cotizaci√≥n v√°lida por 24 horas. Disponibilidad sujeta a inventario en tiempo real.';
            doc.text(noteText, 105, yPosition + 25, { align: 'center', maxWidth: 170 });
            
            // Guardar PDF
            doc.save(`${quoteNumber}_${clientName.replace(/\s+/g, '_')}.pdf`);
            
            // Incrementar contador
            quoteCounter++;
            localStorage.setItem('quoteCounter', quoteCounter);
            
            showNotification('‚úÖ PDF generado correctamente', 'success');
        }

        function clearQuote() {
            quoteItems = [];
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.value = 0;
            });
            updateQuotePanel();
            updateQuoteButton();
            showNotification('üóëÔ∏è Cotizaci√≥n limpiada', 'info');
        }

        // ===== DASHBOARD KPIs =====
        function showKPILogin() {
            document.getElementById('kpiLogin').style.display = 'block';
            document.getElementById('accessKPIButton').style.display = 'none';
        }

        function hideKPILogin() {
            document.getElementById('kpiLogin').style.display = 'none';
            document.getElementById('accessKPIButton').style.display = 'block';
        }

        function loginToDashboard() {
            const user = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPassword').value;
            
            // Credenciales simples para demo (en producci√≥n usar autenticaci√≥n segura)
            if (user === 'admin' && password === 'ipb2024') {
                document.getElementById('kpiLogin').style.display = 'none';
                document.getElementById('kpiDashboard').style.display = 'block';
                document.getElementById('accessKPIButton').style.display = 'none';
                loadDashboardData();
                showNotification('‚úÖ Acceso concedido al Dashboard', 'success');
            } else {
                showNotification('‚ùå Usuario o contrase√±a incorrectos', 'error');
            }
        }

        function hideDashboard() {
            document.getElementById('kpiDashboard').style.display = 'none';
            document.getElementById('accessKPIButton').style.display = 'block';
        }

        function loadDashboardData() {
            // Actualizar m√©tricas
            document.getElementById('totalProducts').textContent = inventoryData.length;
            document.getElementById('totalQuotes').textContent = quoteCounter - 1;
            
            const lowStockCount = inventoryData.filter(item => item.cantidad < 5).length;
            document.getElementById('lowStock').textContent = lowStockCount;
            
            // Crear gr√°fico
            createProductsChart();
        }

        function createProductsChart() {
            const ctx = document.getElementById('productsChart').getContext('2d');
            
            // Agrupar por marca
            const brands = {};
            inventoryData.forEach(item => {
                if (!brands[item.marca]) {
                    brands[item.marca] = 0;
                }
                brands[item.marca]++;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(brands),
                    datasets: [{
                        label: 'Productos por Marca',
                        data: Object.values(brands),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ===== FUNCIONES DE UTILIDAD =====

        function getStockColor(quantity) {
            if (quantity === 0) return '#e74c3c';
            if (quantity < 5) return '#f39c12';
            if (quantity <= 10) return '#3498db';
            return '#27ae60';
        }

        function updateQuoteButton() {
            const button = document.getElementById('generateQuote');
            const clientName = document.getElementById('clientName').value.trim();
            const clientRIF = document.getElementById('clientRIF').value.trim();
            
            button.disabled = quoteItems.length === 0 || !clientName || !clientRIF;
        }

        function updateSystemStatus() {
            document.getElementById('update-time').textContent = new Date().toLocaleString();
        }

        function showLoading(show) {
            const loading = document.getElementById('loading-message');
            loading.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            showLoading(false);
        }

        // ===== NOTIFICACIONES =====
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryData();
            
            // Actualizar estado del bot√≥n cuando cambien los datos del cliente
            document.getElementById('clientName').addEventListener('input', updateQuoteButton);
            document.getElementById('clientRIF').addEventListener('input', updateQuoteButton);
            
            document.getElementById('quickActions').addEventListener('click', function() {
                showNotification('‚ö° Acciones r√°pidas ejecutadas', 'info');
            });
            
            setInterval(updateSystemStatus, 60000);
            
            // Mostrar n√∫mero de cotizaci√≥n actual
            document.getElementById('quoteNumber').textContent = quoteCounter.toString().padStart(5, '0');
        });
    </script>
</body>
</html>
